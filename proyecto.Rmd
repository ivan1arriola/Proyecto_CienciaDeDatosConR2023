---
title: "Proyecto"
output: html_document
date: "2023-06-14"
---

## De donde sacamos la informacion
Mapas - https://github.com/tereom/taller-mapas-mv/


```{r Librerias , message=FALSE}
library(tidyverse)
library(DBI)
library(RPostgres)
library(sf)
library(leaflet)
```

```{r Variables de Entorno, eval=FALSE, echo=FALSE}
usethis::edit_r_environ(
  scope = "project"
)
```

```{r Coneccion a Base de Datos}
con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host = Sys.getenv("DB_HOST"),
  port = Sys.getenv("DB_PORT"),
  user = Sys.getenv("DB_USER"),
  password = Sys.getenv("DB_PASS"),
  dbname = Sys.getenv("DB_NAME")
)
```

```{r Tablas de la base de datos}
# Obtener las tablas de la base de datos
(tablas <- DBI::dbListTables(con) )

# Obtener las variables de las tablas
for (i in tablas){
  cant <- dbGetQuery(con, paste("Select count(*) from", i ))[1,1]
  cat(i, "cant : ")
  print(cant)
  print(DBI::dbListFields(con, name = i))
  cat("\n")
}

```

```{r d_sensores}
(
  d_sensores <- DBI::dbGetQuery(
  con,
  "SELECT * FROM d_sensores"
  )
)
```

```{r NA's en d_sensores$barrio}

d_sensores %>% select(barrio) %>% summarise( NAs = sum(is.na(barrio)))

```


```{r Mapa y Funciones para mapa}
mvd_map <- st_read(here::here("./ine_barrios/ine_barrios_mvd_nbi85.shp"))

transformarCoord <- function(lat, lon, mvd_map){
  puntos_lat_lng <- data.frame(lng = lon, lat = lat)
  puntos_sf <- st_as_sf(puntos_lat_lng,
                        coords = c("lng", "lat"),
                        crs = 4326)
  puntos_transformados <- st_transform(puntos_sf,
                                       crs = st_crs(mvd_map))
  return(puntos_transformados)
}
```



```{r Mapa De Sensores}
puntos_sensores <- d_sensores %>% 
  select(latitud, longitud) %>%
  mutate(puntos_transformados = transformarCoord(latitud, longitud, mvd_map))

mvd_map %>%
  ggplot() + 
  geom_sf(colour = "grey75", size = 0.07) +
  geom_sf(data = puntos_sensores$puntos_transformados, color = "red", size = 1) +
  labs(title = "Mapa de la ubicacion de los sensores")


```

# Preguntas de Investigación

1.  ¿Influye el barrio con la velocidad a la que van los vehículos?
2.  ¿Existe alguna correlación entre el volumen de tráfico y la velocidad promedio en las avenidas de Montevideo?
3.  ¿Existen diferencias en el volumen de tráfico y la velocidad promedio entre días laborales y fines de semana?
4.  ¿Cuáles son las avenidas con los marzores promedios de velocidad en Montevideo?

## 1 -  ¿Influye el barrio con la velocidad a la que van los vehículos?

```{r Importar velocidad - barrio  }
(
  velocidadBarrioMedia <- DBI::dbGetQuery(
    con,
    "
    SELECT
      d_sensores.barrio,
      AVG(fct_registros.velocidad) AS promedio_velocidad
    FROM fct_registros
    LEFT JOIN d_sensores ON fct_registros.id_detector = d_sensores.id_detector
    GROUP BY d_sensores.barrio
    "
  )

)

```

```{r}
velocidadBarrioMedia %>% 
  filter(barrio != 'NA') %>% 
  ggplot(aes(y = promedio_velocidad,
             x= fct_reorder(barrio, promedio_velocidad)
        )
    ) +
  geom_col() +
  coord_flip() +
  theme(
    aspect.ratio = 1,
  ) +
  scale_x_discrete(name = "Barrio") + 
  scale_y_continuous(name = "Promedio de Velocidad")
  

```


```{r Funcion para encontrar el barrio}
encontrar_barrio <- function(lat, lon, mvd_map) {
  # Convertir las coordenadas geográficas a un objeto espacial sf
  puntos_transformados <- transformarCoord(lat, lon, mvd_map)

  # Encontrar el barrio que contiene el punto
  ls_contains <- st_contains(mvd_map$geometry,
                             puntos_transformados$geometry)
  indice_barrio <- which(as.logical(ls_contains))[1]
  matching_barrios <- mvd_map[indice_barrio, ]

  # Obtener el nombre del barrio
  barrio <- matching_barrios$NOMBBARR

  # Retornar el nombre del barrio
  return(barrio)
}
```


```{r}
puntos <- data.frame(
  lat = c(-34.86988, -34.87866, -34.87491, -34.89415),
  lon = c(-56.13489, -56.14714, -56.14017, -56.16750)
)

# Obtener el nombre del barrio para cada punto
for (i in 1:nrow(puntos)) {
  barrio <- encontrar_barrio(puntos$lat[i], puntos$lon[i], mvd_map)
  print(paste("El punto", i, "se encuentra en el barrio:", barrio))
}

#[1] "El punto 1 se encuentra en el barrio: Union"
#[1] "El punto 2 se encuentra en el barrio: Union"
#[1] "El punto 3 se encuentra en el barrio: Union"
#[1] "El punto 4 se encuentra en el barrio: Tres Cruces"
```



```{r Mapa con velocidad media por barrio}
(
  mvd_map_velocidad_media <- mvd_map %>%
    left_join(velocidadBarrioMedia,
              by = c("NOMBBARR" = "barrio"))
)

mvd_map_velocidad_media %>%
  ggplot(aes(fill = promedio_velocidad)) + 
  geom_sf(colour = "grey75", size = 0.07) +
  scale_color_paletteer_c(palette = "viridis::plasma")
```










## 4 - ¿Cuáles son las avenidas con los mayores promedios de velocidad en Montevideo?

Para responder a esta pregunta, necesito determinar en que intervalo de tiempo voy a considerar el promedio. Ahora como primer acercamiento a los datos, me interesa determinar el promedio de velocidades por radar (cual va a estar en una determinada avenida), en el periodo de *marzo 2023*.

```{r}
(
  promedios_velocidad_marzo23 <- DBI::dbGetQuery(
    con,
    "
      SELECT
        fct_registros.velocidad, 
        fct_registros.id_hora, 
        d_sensores.dsc_avenida, 
        d_date.mmyyyy, 
        d_sensores.latitud, 
        d_sensores.longitud
      FROM fct_registros
      LEFT JOIN 
        d_sensores 
        ON 
          fct_registros.id_detector = d_sensores.id_detector
      LEFT JOIN 
        d_date 
        ON 
          fct_registros.id_fecha = d_date.id_fecha
      LIMIT 10000    
    "
  )
)

```

Ahora quiero visualizar en que partes de montevideo fueron observados estos datos

```{r Cantidad de veces que se paso el limite de 60km/h en Marzo 2023 x Sensor}
(
cantMarzorLimite60 <- promedios_velocidad_marzo23 %>% 
  select(dsc_avenida, latitud, longitud, velocidad) %>% 
  group_by(dsc_avenida, latitud, longitud) %>% 
  summarise(
    cantMayorALimite = sum(velocidad > 60)
  ) %>% arrange(desc(cantMayorALimite))
)

```

```{r, Calles con mayor promedio}

promedios_velocidad_marzo23 %>%
  group_by(dsc_avenida) %>%
  summarise(velocidad_promedio = round(mean(velocidad), 3)) %>%
  filter(velocidad_promedio > 40) %>%
  ggplot() +
  geom_col(
    aes(x = velocidad_promedio,
        y = reorder(dsc_avenida, velocidad_promedio)
        )
    ) +
  scale_x_continuous(name = "Velocidad promedio") +
  scale_y_discrete(name = "Calles")

```


```{r Mapa de las observaciones}

div <- function(cantMayorALimite) {
  paste0("<div>", cantMayorALimite, "</div>")
}


#Clasifica 
getColor <- function(cantMayorALimite) {
  ifelse(cantMayorALimite <= 100, "green", ifelse(cantMayorALimite <= 1000, "orange", "red"))
}


icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = getColor(cantMarzorLimite60$cantMayorALimite)
)

leaflet(cantMarzorLimite60) %>%
  addTiles() %>%
  addAwesomeMarkers(lat = ~latitud, lng = ~longitud, icon = icons,
             label = ~dsc_avenida,
             popup = div(cantMarzorLimite60$cantMayorALimite)
             )


```


## 2.¿Existe alguna correlación entre el volumen de tráfico y la velocidad promedio en las avenidas de Montevideo?

```{r Importar velocidad - fecha - volumen - avenida }
(
  promediosMarzo23 <- DBI::dbGetQuery(
    con,
    "
      WITH velocidad_volumen_enero_2023 AS (
  SELECT
    fct_registros.velocidad,
    fct_registros.volume,
    d_sensores.dsc_avenida, 
    d_date.year_actual
  FROM fct_registros
  LEFT JOIN d_sensores ON fct_registros.id_detector = d_sensores.id_detector
  LEFT JOIN d_date ON fct_registros.id_fecha = d_date.id_fecha
),
promedios_marzo_23 AS (
  SELECT
    dsc_avenida,
    year_actual,
    AVG(velocidad) AS velocidad_media,
    AVG(volume) AS volumen_media
  FROM velocidad_volumen_enero_2023
  GROUP BY dsc_avenida, year_actual
)
SELECT *
FROM promedios_marzo_23

    "
  )
)

```

```{r}
promediosMarzo23 %>% 
  ggplot(
    aes(
      x = velocidad_media,
      y = volumen_media
    )
  ) +
  geom_point() + 
  facet_wrap(~year_actual) +
  scale_x_continuous(name = "Velocidad Media Anual") +
  scale_y_continuous(name = "Volumen de Vehiculos Medio Anual") 
  theme(aspect.ratio = 1)
  
    
```

El grafico no muestra una relacion aparente entre los promedios de las variables