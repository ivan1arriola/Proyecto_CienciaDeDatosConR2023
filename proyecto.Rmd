---
author: "Arriola, Miquelerena, Rovetta"
output:
  html_document: default
---

# Proyecto Final

```{r Librerias , include = FALSE}
library(magrittr)
library(forcats)
library(DBI)
library(ggplot2)
library(dplyr)
library(RPostgres)
library(sf)
library(paletteer)
library(geouy)
library(spdep)
library(leaflet)
source(here::here("app", "utils.R"))
```

```{r Variables de Entorno, eval=FALSE, echo=FALSE}
usethis::edit_r_environ(
  scope = "project"
)
```

## Introduccion

### Preguntas de Investigación

1.  ~~¿Influye el barrio con la velocidad a la que van los vehículos?~~

1. Variacion a la velocidad durante el dia

2.  ¿Existe alguna correlación entre el volumen de tráfico y la velocidad promedio en las avenidas de Montevideo?

3.  ¿Existen diferencias en el volumen de tráfico y la velocidad promedio entre días laborales y fines de semana?

4.  ¿Cuáles son las avenidas con los marzores promedios de velocidad en Montevideo?

5.  **nueva** ¿Como afecta la presencia de semaforo a los indicadores de volumen y velocidad?

## Datos

Tenemos 4 conjuntos de datos:

-   [Conteo vehicular en las principales avenidas de Montevideo](https://catalogodatos.gub.uy/dataset/intendencia-montevideo-conteo-de-vehiculos-del-centro-de-gestion-de-la-movilidad)

-   [Velocidad promedio vehicular en las principales avenidas de Montevideo](https://catalogodatos.gub.uy/dataset/intendencia-montevideo-velocidad-promedio-vehicular-en-las-principales-avenidas-de-montevideo)

-   [Ubicación de sensores de medición de conteo vehículos](https://catalogodatos.gub.uy/dataset/intendencia-montevideo-ubicacion-de-sensores-de-medicion-de-conteo-vehiculos)

-   [Semafotos](https://geoweb.montevideo.gub.uy/geonetwork/srv/api/records/d2da8cdd-c718-4eeb-9825-7069498b29c2)

### Observaciones

Los datos son mensuales. Van desde Enero 2021 hasta Abril 2023.

Los datos de semaforos corresponden a a setiembre del 2014.

## Base de datos

Los datos fueron cargados en una base de datos debido a la cantidad de informacion a manejar ....

```{r Coneccion a Base de Datos , echo=FALSE}
con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host = Sys.getenv("DB_HOST"),
  port = Sys.getenv("DB_PORT"),
  user = Sys.getenv("DB_USER"),
  password = Sys.getenv("DB_PASS"),
  dbname = Sys.getenv("DB_NAME")
)
```

```{r Tablas de la base de datos , echo=FALSE}
# Obtener nombres de las tablas de la base de datos
tablas <- DBI::dbListTables(con)

# Obtener las variables de las tablas
for (i in tablas){
  cant <- dbGetQuery(con, paste("Select count(*) from", i ))[1,1]
  print(paste("Tabla: ", i))
  print(paste("Cantidad de datos: ", cant))
  print("Varibales de la tabla:")
  print(DBI::dbListFields(con, name = i))
  cat("\n", "\n")
}
```

## Analisis Exploratorio

### Datos espaciales

Nuestros datos estan todos asociados con una ubicacion geografica

```{r Cargar Mapas , sensores, semaforos, message=FALSE  , echo=FALSE, include=FALSE}
d_sensores <- DBI::dbGetQuery(
  con,
  "SELECT * FROM d_sensores"
  )
mvd_map <- load_geouy("Barrios")
mvd_map_fixed <- st_make_valid(st_transform(mvd_map, crs = 4326))
puntos_sensores <- d_sensores %>% 
  select(latitud, longitud) %>%
  mutate(puntos_transformados = transformarCoord(latitud, longitud, mvd_map))
capaSemafotos <- st_read(here::here("v_int_semaforos", "v_int_semaforos.shp"))
```

```{r Visualizacion de los elementos geolocalizables de los datos , echo=FALSE}
# Crear una paleta de colores discreta, usando una funcion que indica como colorear para evitar
# que queden 
colores <- colorFactor(
  palette = "Set1", 
  domain = nacol(mvd_map_fixed)
)

# Crear el mapa interactivo con una capa de polígonos
(
  map <- leaflet() %>%
  addTiles() %>%
  addPolygons(
    data=mvd_map_fixed,
    weight = 5,
    opacity = 0.5,
    fill = TRUE,
    fillColor = ~colores(nacol(mvd_map_fixed)),
    popup = NULL,
    popupOptions = NULL,
    label = ~stringr::str_to_title(nombbarr) 
  ) %>% 
    addMarkers(
    data = st_transform(capaSemafotos, crs = 4326), 
    icon= semaforoIcon,
    opacity = 0.5,
  ) %>% 
  addMarkers(
    data = d_sensores, 
    lat = ~latitud, 
    lng = ~longitud,
    label = ~paste(dsc_avenida, " - ", dsc_int_anterior, " - ", dsc_int_siguiente)
  )
  
)

```

Los Markers azules son la ubicacion de los sensores

Los circulos rojos son los semaforos

### Variacion del promedio de la velocidad por hora

```{r Datos de la velcidad por hora}

velocidad_hora <- DBI::dbGetQuery(
  con,
  " WITH asd as (
      WITH velocidad_hora  AS (
        SELECT
          velocidad, 
          id_hora
        FROM fct_registros
        ORDER BY id_hora
      )
      SELECT 
        AVG(velocidad) as avg_velocidad,
        MAX(velocidad) as max_velocidad,
        id_hora as hora
      FROM velocidad_hora
      GROUP BY id_hora
  )
  select *,
  avg(avg_velocidad) OVER(ORDER BY hora
     ROWS BETWEEN 30 PRECEDING AND CURRENT ROW )
     as moving_average
from asd;
    
  "
  )

#select *,
#  avg(Price) OVER(ORDER BY Date
#     ROWS BETWEEN 2 PRECEDING AND CURRENT ROW )
#     as moving_average
#from stock_price;

```


https://www.postgresql.org/docs/current/tutorial-window.html 

```{r}
velocidad_hora %>% ggplot(
  aes(
    x = hora,
    y = moving_average
  )
) + geom_line()
```
SHINY 





## Modelo Estadistico

## Descripcion de app Shiny

## Comentarios Finales
