---
title: "Proyecto"
output: html_document
date: "2023-06-14"
---


```{r Librerias , message=FALSE}
library(tidyverse)
library(DBI)
library(RPostgres)
```

```{r Variables de Entorno, eval=FALSE, echo=FALSE}
usethis::edit_r_environ(
  scope = "project"
)
```

```{r Coneccion a Base de Datos}
con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host = Sys.getenv("DB_HOST"),
  port = Sys.getenv("DB_PORT"),
  user = Sys.getenv("DB_USER"),
  password = Sys.getenv("DB_PASS"),
  dbname = Sys.getenv("DB_NAME")
)
```

```{r Tablas de la base de datos}
# Obtener las tablas de la base de datos
(tablas <- DBI::dbListTables(con) )

# Obtener las variables de las tablas
for (i in tablas){
  cant <- dbGetQuery(con, paste("Select count(*) from", i ))[1,1]
  cat(i, "cant : ")
  print(cant)
  print(DBI::dbListFields(con, name = i))
  cat("\n")
}

```

```{r d_sensores}
(
  d_sensores <- DBI::dbGetQuery(
  con,
  "SELECT * FROM d_sensores"
  )
)
```

```{r}

```

```{r Mapa De Sensores}
library(leaflet)

(
  map <- leaflet() %>%
    addTiles() %>%
    addMarkerClusterOptions(clusterOptions = markerClusterOptions()) %>%
    addMarkers(data = datos, lat = ~latitud, lng = ~longitud,
             label = ~paste(dsc_avenida, " - ", dsc_int_anterior, " - ", dsc_int_siguiente))
)

```

## Preguntas de Investigación

1.  ¿Influye el barrio con la velocidad a la que van los vehículos?
2.  ¿Existe alguna correlación entre el volumen de tráfico y la velocidad promedio en las avenidas de Montevideo?
3.  ¿Existen diferencias en el volumen de tráfico y la velocidad promedio entre días laborales y fines de semana?
4.  ¿Cuáles son las avenidas con los marzores promedios de velocidad en Montevideo?

# ¿Cuáles son las avenidas con los marzores promedios de velocidad en Montevideo?

Para responder a esta pregunta, necesito determinar en que intervalo de tiempo voy a considerar el promedio. Ahora como primer acercamiento a los datos, me interesa determinar el promedio de velocidades por radar (cual va a estar en una determinada avenida), en el periodo de *marzo 2023*.

```{r}
(
  promedios_velocidad_marzo23 <- DBI::dbGetQuery(
    con,
    "
      SELECT
        fct_registros.velocidad, 
        fct_registros.id_hora, 
        d_sensores.dsc_avenida, 
        d_date.mmyyyy, 
        d_sensores.latitud, 
        d_sensores.longitud
      FROM fct_registros
      LEFT JOIN 
        d_sensores 
        ON 
          fct_registros.id_detector = d_sensores.id_detector
      LEFT JOIN 
        d_date 
        ON 
          fct_registros.id_fecha = d_date.id_fecha
      WHERE d_date.mmyyyy = '102021'

    "
  )
)

```

Ahora quiero visualizar en que partes de montevideo fueron observados estos datos

```{r Cantidad de veces que se paso el limite de 60km/h en Marzo 2023}
(
cantMarzorLimite60 <- promedios_velocidad_marzo23 %>% 
  select(dsc_avenida, latitud, longitud, velocidad) %>% 
  group_by(dsc_avenida, latitud, longitud) %>% 
  summarise(
    cantMayorALimite = sum(velocidad > 60)
  ) %>% arrange(desc(cantMayorALimite))
)

```



```{r Mapa de las observaciones}
(
radares_marzo23R <- cantMarzorLimite60
)

getColor <- function(cantMayorALimite) {
  ifelse(cantMayorALimite <= 100, "green", ifelse(cantMayorALimite <= 1000, "orange", "red"))
}


icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = getColor(radares_marzo23R$cantMayorALimite)
)

leaflet(radares_marzo23R) %>%
  addTiles() %>%
  addAwesomeMarkers(lat = ~latitud, lng = ~longitud, icon=icons,
             label = ~dsc_avenida
             )


```





```{r getBarrio}
library(httr)
library(jsonlite)


getBarrio <- function(lat, lng) {
  url <- "https://maps.googleapis.com/maps/api/geocode/json"
  api_key <- Sys.getenv("GOOGLE_KEY")
  
  params <- list(
    latlng = paste(lat, lng, sep = ","),
    key = api_key,
    result_type = "neighborhood"
  )
  response <- GET(url, query = params)
  
  if (http_status(response)$category != "Success") {
    stop("Error en la solicitud a la API de Google Maps")
  }
  
  data <- content(response)
  
  if (data$status != "OK" || length(data$results) == 0) {
    print(c(lat, lng))
    
    params <- list(
      latlng = paste(lat, lng, sep = ","),
      key = api_key
    )
    response <- GET(url, query = params)
    data <- content(response)
    print(data$results[[1]]$address_components[[3]]$long_name)
    return(NA)
  }
  
  barrio <- data$results[[1]]$address_components[[1]]$long_name
  return(barrio)
}


```

```{r Obtener los barrios, eval=FALSE}
cant <- length(cantMarzorLimite60$latitud)

# Obtener los barrios para cada par de coordenadas
barrios <- sapply(1:cant, function(i) {
  getBarrio(cantMarzorLimite60$latitud[i], cantMarzorLimite60$longitud[i])
})

# Asignar los barrios al dataframe
(cantMarzorLimite60$Barrio <- barrios)
```


## 2.¿Existe alguna correlación entre el volumen de tráfico y la velocidad promedio en las avenidas de Montevideo?


```{r Importar velocidad - fecha - volumen - avenida }
(
  promediosMarzo23 <- DBI::dbGetQuery(
    con,
    "
      WITH velocidad_volumen_enero_2023 AS (
  SELECT
    fct_registros.velocidad,
    fct_registros.volume,
    d_sensores.dsc_avenida, 
    d_date.year_actual
  FROM fct_registros
  LEFT JOIN d_sensores ON fct_registros.id_detector = d_sensores.id_detector
  LEFT JOIN d_date ON fct_registros.id_fecha = d_date.id_fecha
),
promedios_marzo_23 AS (
  SELECT
    dsc_avenida,
    year_actual,
    AVG(velocidad) AS velocidad_media,
    AVG(volume) AS volumen_media
  FROM velocidad_volumen_enero_2023
  GROUP BY dsc_avenida, year_actual
)
SELECT *
FROM promedios_marzo_23

    "
  )
)

```



```{r}
promediosMarzo23 %>% 
  ggplot(
    aes(
      x = velocidad_media,
      y = volumen_media
    )
  ) +
  geom_point() + 
  facet_wrap(~year_actual) +
  scale_x_continuous(name = "Velocidad Media Anual") +
  scale_y_continuous(name = "Volumen de Vehiculos Medio Anual") 
  theme()
  
    
```
El grafico no muestra una relacion aparente entre los promedios de las variables



